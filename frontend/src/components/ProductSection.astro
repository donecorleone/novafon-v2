---
// Einfach: Backend-Daten laden und mappen
let products = [];

try {
  const response = await fetch('http://localhost:8000/products');
  const data = await response.json();
  products = data.map(([_, productId, name, category, stock, price]) => ({
    productId,
    name,
    category,
    stock,
    price
  }));
} catch (error) {
  console.error('Fehler beim Laden der Produkte:', error);
  products = [];
}
---

<div class="w-full min-h-screen flex justify-center items-center">
  <div class="flex flex-wrap gap-5">
    {products.map((product) => (
      <div class="product w-[400px] h-fit rounded-3xl flex flex-col overflow-hidden">
        <div class="img-container w-full h-[370px]">
          <img src="/assets/product-1.png" alt={product.name} />
        </div>
        <div class="content-container w-full h-[320px]">
          <h3 class="mb-5"><b>{product.name}</b></h3>
          <p class="product-details">
            5 Intensitätsstufen<br />
            3 Frequenzen (50, 70 % 100 Hz)<br />
            App Connectivity
          </p>
          <div class="price-containe flex flex-row">
            <p class="price">
              {typeof product.price === 'number' ? `${product.price.toFixed(2)} €` : '-'}
            </p>
            <p class="discount-price" id={`discount-${product.productId}`} style="display: none;"></p>
          </div>
          <div class="flex flex-row justify-between">
            <button>Zum Produkt</button>
            <button class="buy-btn" data-product-id={product.productId}>
              <img src="/assets/shopping-cart.webp" alt="shopping cart icon" class="max-h-[30px] w-auto" />
            </button>
          </div>
        </div>
      </div>
    ))}
  </div>
</div>

<script>
// Super einfach: Nur Buy-Button funktionalität
document.addEventListener('DOMContentLoaded', () => {
  
  // Rabattpreise direkt vom Backend holen
  async function showDiscounts() {
    try {
      // Annotierten Warenkorb holen - Backend berechnet discounted_unit_price für alle Produkte
      const response = await fetch('http://localhost:8000/cart/annotated');
      const data = await response.json();
      
      // Alle Items durchgehen und Rabattpreise anzeigen
      data.items.forEach(item => {
        const discountEl = document.getElementById(`discount-${item.productId}`);
        if (discountEl && item.rabatt && item.discounted_unit_price < item.unit_price) {
          discountEl.textContent = `${item.discounted_unit_price.toFixed(2)} € (Treuebonus)`;
          discountEl.style.display = 'block';
          discountEl.style.color = '#dc2626';
          discountEl.style.fontWeight = 'bold';
        }
      });
    } catch (error) {
      console.error('Fehler beim Laden der Rabatte:', error);
    }
  }

  // Rabatte beim Laden anzeigen
  showDiscounts();

  // Buy-Button: Produkt zum Warenkorb hinzufügen
  document.addEventListener('click', async (e) => {
    const buyBtn = e.target.closest('.buy-btn');
    if (!buyBtn) return;

    const productId = buyBtn.dataset.productId;
    
    try {
      // Aktuelle Menge holen und +1 hinzufügen
      const cartResponse = await fetch('http://localhost:8000/cart');
      const cart = await cartResponse.json();
      const existingItem = cart.items.find(item => item.productId === productId);
      const newQuantity = existingItem ? existingItem.quantity + 1 : 1;

      // Backend macht alle Berechnungen - nur Menge setzen
      await fetch(`http://localhost:8000/cart/items/${productId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ quantity: newQuantity })
      });

      // Rabatte neu anzeigen
      await showDiscounts();

      // CartDrawer benachrichtigen
      window.dispatchEvent(new CustomEvent('cartUpdated'));

      // CartDrawer öffnen
      const drawer = document.getElementById('drawer');
      if (drawer) drawer.showModal();

    } catch (error) {
      console.error('Fehler beim Hinzufügen zum Warenkorb:', error);
    }
  });
});
</script>


<style>
  .content-container {
    padding: 40px 20px;
    background-color: white;
  }

  .img-container {
    background-image: linear-gradient(to bottom, #bdc2c9, #ced1d6, #dfe0e4, #efeff1, #ffffff);
  }

  .product-details {
    margin: 15px 0 40px 0;
  }

  .price-container {
    margin: 20px 0;
  }

  .price {
    font-size: 24px;
    margin: 0;
  }

  .discount-price {
    font-size: 16px;
    margin-left: 20px;
    margin-top: 5px;
    font-weight: 200;
  }

  .buy-btn {
    cursor: pointer;
    border: none;
    background: none;
    padding: 8px;
    border-radius: 4px;
    transition: background-color 0.2s;
  }

  .buy-btn:hover {
    background-color: rgba(0, 0, 0, 0.05);
  }

  @media screen and (max-width: 669px) {
    .product {
      max-width: 370px;
    }
  }
</style>